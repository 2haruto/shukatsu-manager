{% extends "base.html" %}

{% block title %}企業一覧 | 就活管理アプリ{% endblock %}

{% block content %}
<div class="card">
  <div class="form-header">
    <div class="form-header-left">
      <h2 class="page-title">企業一覧</h2>
      <p class="form-description">
        ステータス、ES締切、提出状況、次の面接を一覧で確認できます。
      </p>
    </div>

    <div class="actions" style="margin: 0;">
      <a href="{% url 'company_create' %}" class="button">＋企業追加</a>
    </div>
  </div>

  <div class="summary-grid">
    <div class="summary-card">
      <div class="summary-label">登録企業</div>
      <div class="summary-value">{{ total_count }}</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">ES提出済み</div>
      <div class="summary-value">{{ es_submitted_count }}</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">締切7日以内</div>
      <div class="summary-value">{{ deadline_soon_count }}</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">締切超過</div>
      <div class="summary-value">{{ deadline_overdue_count }}</div>
    </div>
  </div>

  <form method="get" class="filter-form">
    <div class="form-group">
      <label for="keyword">企業名検索</label>
      <input
        type="text"
        name="keyword"
        id="keyword"
        value="{{ keyword }}"
        placeholder="企業名を入力"
      >
    </div>

    <div class="form-group">
      <label for="status">ステータス</label>
      <select name="status" id="status">
        <option value="">すべて</option>
        {% for value, label in status_choices %}
          <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="sort">並び替え</label>
      <select name="sort" id="sort">
        {% for value, label in sort_choices %}
          <option value="{{ value }}" {% if selected_sort == value %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>

    <button type="submit">検索</button>

    {% if keyword or selected_status or selected_sort != "updated_desc" %}
      <a href="{% url 'company_list' %}" class="button button-secondary">リセット</a>
    {% endif %}
  </form>

  <p class="muted">表示件数：{{ filtered_count }}件 / 全{{ total_count }}件</p>

  {% if companies %}
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>企業名</th>
            <th>ステータス</th>
            <th>優先度</th>
            <th>ES締切</th>
            <th>ES提出</th>
            <th>次の面接</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for c in companies %}
            <tr>
              <td>
                <strong>{{ c.name }}</strong><br>
                <span class="muted">{{ c.role|default:"職種未設定" }}</span>
              </td>

              <td>
                <span class="badge">{{ c.get_status_display }}</span>
              </td>

              <td>{{ c.priority }}</td>

              <td>
                {% if c.entry_deadline %}
                  {{ c.entry_deadline|date:"Y-m-d" }}<br>

                  {% if not c.es_submitted %}
                    {% if c.entry_deadline < today %}
                      <span class="status-chip status-chip-danger">締切超過</span>
                    {% elif c.entry_deadline <= soon_date %}
                      <span class="status-chip status-chip-warning">締切近い</span>
                    {% endif %}
                  {% endif %}
                {% else %}
                  <span class="muted">未設定</span>
                {% endif %}
              </td>

              <td>
                {% if c.es_submitted %}
                  <span class="badge">提出済み</span>
                  {% if c.es_submitted_at %}
                    <br>
                    <span class="muted">{{ c.es_submitted_at|date:"Y-m-d" }}</span>
                  {% endif %}
                {% else %}
                  <span class="badge">未提出</span>
                {% endif %}
              </td>

              <td>
                {% if c.next_interview_at %}
                  {{ c.next_interview_at|date:"Y-m-d H:i" }}
                {% else %}
                  <span class="muted">予定なし</span>
                {% endif %}
              </td>

              <td>
                <a href="{% url 'company_detail' c.id %}">詳細</a> /
                <a href="{% url 'company_update' c.id %}">編集</a> /
                <a href="{% url 'interview_create' %}?company={{ c.id }}">面接追加</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="empty-message">条件に合う企業はありません。</p>
  {% endif %}
</div>
{% endblock %}